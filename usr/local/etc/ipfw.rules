#!/bin/sh
cmd="ipfw -q add"
ipfw -q -f flush  # Flush all existing rules

### === BASIC & LOCAL TRAFFIC ===
$cmd 10 allow all from any to any via lo0
$cmd 20 deny all from any to 127.0.0.0/8
$cmd 30 deny all from 127.0.0.0/8 to any

### === TCP PROTECTION ===
$cmd 40 deny tcp from any to any frag

### === INTERNAL NETWORKS ===
$cmd 45 deny ip from { 10.0.0.0/8, 172.16.0.0/12 } to any in
$cmd 46 allow ip from 192.168.0.0/16 to any
$cmd 47 allow ip from any to 192.168.1.1
$cmd 48 allow ip from any to 172.25.0.0/16

### === DHCP ===
$cmd 130 allow udp from me 68 to any 67 out
$cmd 131 allow udp from any 67 to me 68 in

### === DNS ===
$cmd 132 allow udp from me to any 53 out
$cmd 133 allow udp from any to me 53 in

### === CONNECTION TRACKING ===
$cmd 50 check-state
$cmd 60 allow tcp from any to any established
$cmd 70 allow ip from me to any out keep-state

### === ICMP ===
$cmd 80 allow icmp from any to me icmptypes 0,3,8,11
$cmd 82 allow icmp from any to any icmptypes 3,11
$cmd 85 allow icmp from me to any icmptypes 0 out

### === ALLOWED SERVICES (HTTP/HTTPS for portal login) ===
$cmd 100 allow tcp from any to me 80 in
$cmd 101 allow tcp from any to me 443 in

### === LOCAL NETWORK SERVICES ===
$cmd 170 allow udp from 192.168.1.0/24 to me 5353 in

### === LOGGING & SECURITY ===
$cmd 150 deny log tcp from any to any 8333,4444,5555,31337,6667 out
$cmd 151 deny log udp from any to any 8333,4444,5555 out

### === DEFAULT POLICY ===
$cmd 190 allow ip from 192.168.0.0/16 to any
$cmd 191 allow ip from me to any out keep-state
$cmd 192 allow ip from any to me in via wlan0 keep-state
$cmd 999 deny log ip from any to any
